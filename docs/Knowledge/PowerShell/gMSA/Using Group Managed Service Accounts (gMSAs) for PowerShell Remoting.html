<!DOCTYPE html><html><head><title>Codedoc</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/codedoc/docs/images/KostweinLogo.ico"><link href="https://fonts.googleapis.com/css?family=Roboto:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Roboto', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/codedoc/docs/assets/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/codedoc/docs/assets/codedoc-bundle.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"></head><body data-path="docs\Knowledge\PowerShell\gMSA\Using Group Managed Service Accounts (gMSAs) for PowerShell Remoting.md"><div class="header-0-0-6"><script async="" defer="" src="https://buttons.github.io/buttons.js"></script><a class="github-button" data-color-scheme="no-preference: light; light: light; dark: dark;" data-icon="false" data-show-count="true" data-size="false" href="https://github.com/In-Pro-Org/codedoc/">Star</a><br><br><a class="watermark-0-0-5" href="https://github.com/CONNECT-platform/codedoc" target="_blank">Created With<svg viewBox="0 0 536 296" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="codedoc" transform="translate(-244.000000, -364.000000)" fill-rule="nonzero"><path d="M580,532 C615.346224,532 644,560.653776 644,596 C644,631.346224 615.346224,660 580,660 C544.653776,660 516,631.346224 516,596 C516,560.653776 544.653776,532 580,532 Z M716,532 C751.346224,532 780,560.653776 780,596 C780,631.346224 751.346224,660 716,660 L692,660 C687.581722,660 684,656.418278 684,652 C684,647.581722 687.581722,644 692,644 L716,644 C742.509668,644 764,622.509668 764,596 C764,569.490332 742.509668,548 716,548 L692,548 C687.581722,548 684,544.418278 684,540 C684,535.581722 687.581722,532 692,532 L716,532 Z M468,532 C472.418278,532 476,535.581722 476,540 L476,652 C476,656.418278 472.418278,660 468,660 L444,660 C408.653776,660 380,631.346224 380,596 C380,560.653776 408.653776,532 444,532 L468,532 Z M332,532 C336.418278,532 340,535.581722 340,540 L340,652 C340,656.418278 336.418278,660 332,660 L252,660 C247.581722,660 244,656.418278 244,652 L244,540 C244,535.581722 247.581722,532 252,532 L332,532 Z M580,548 C553.490332,548 532,569.490332 532,596 C532,622.509668 553.490332,644 580,644 C606.509668,644 628,622.509668 628,596 C628,569.490332 606.509668,548 580,548 Z M461,548 L444,548 C417.490332,548 396,569.490332 396,596 C396,622.509668 417.490332,644 444,644 L461,644 L461,548 Z M444,364 C479.346224,364 508,392.653776 508,428 C508,463.346224 479.346224,492 444,492 C408.653776,492 380,463.346224 380,428 C380,392.653776 408.653776,364 444,364 Z M332,364 C336.418278,364 340,367.581722 340,372 C340,376.418278 336.418278,380 332,380 L308,380 C281.490332,380 260,401.490332 260,428 C260,454.509668 281.490332,476 308,476 L332,476 C336.418278,476 340,479.581722 340,484 C340,488.418278 336.418278,492 332,492 L308,492 C272.653776,492 244,463.346224 244,428 C244,392.653776 272.653776,364 308,364 L332,364 Z M580,364 C615.346224,364 644,392.653776 644,428 C644,463.346224 615.346224,492 580,492 L556,492 C551.581722,492 548,488.418278 548,484 L548,372 C548,367.581722 551.581722,364 556,364 L580,364 Z M772,364 C776.418278,364 780,367.581722 780,372 C780,376.418278 776.418278,380 772,380 L700,380 L700,420 L772,420 C776.418278,420 780,423.581722 780,428 C780,432.418278 776.418278,436 772,436 L700,436 L700,476 L772,476 C776.418278,476 780,479.581722 780,484 C780,488.418278 776.418278,492 772,492 L692,492 C687.581722,492 684,488.418278 684,484 L684,372 C684,367.581722 687.581722,364 692,364 L772,364 Z M444,380 C417.490332,380 396,401.490332 396,428 C396,454.509668 417.490332,476 444,476 C470.509668,476 492,454.509668 492,428 C492,401.490332 470.509668,380 444,380 Z M580,380 L563,380 L563,476 L580,476 C606.509668,476 628,454.509668 628,428 C628,401.490332 606.509668,380 580,380 Z"></path></g></svg></a></div><div id="-codedoc-container" class="container"><p><a href="https://amirsayes.co.uk/2023/02/25/using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through/">https://amirsayes.co.uk/2023/02/25/using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through/</a></p><blockquote><p>Using Group Managed Service Accounts (gMSAs) for PowerShell Remoting se Powershell Remoting with Group Managed Service Accounts for better security and passwordless access</p></blockquote><h1 id="using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through---amir-sayes" class="heading-0-0-1"><span class="anchor-0-0-2" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Using Group Managed Service Accounts (gMSAs) for PowerShell Remoting: A Walk-through - Amir Sayes</h1><p><img src="https://i0.wp.com/amirsayes.co.uk/wp-content/uploads/2022/08/2022-08-17-14_01_03-Photos.png?resize=750%2C350&amp;ssl=1" alt="Using Group Managed Service Accounts (gMSAs) for PowerShell Remoting: A Walk-through" title="Using Group Managed Service Accounts (gMSAs) for PowerShell Remoting: A Walk-through"></p><p>PowerShell remoting is a powerful feature that allows administrators to remotely manage Windows machines using PowerShell commands. However, managing credentials for remote access can be a challenge, especially when working with large environments that require access to many different servers. <a href="https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview">Group Managed Service Accounts</a> (gMSAs) provide a secure and easy way to manage credentials for remote access, especially when using PowerShell remoting.</p><p>In this blog post, we will walk through the steps involved in setting up and troubleshooting gMSAs for PowerShell remoting.</p><ul><li><a href="https://amirsayes.co.uk/2023/02/25/using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through/#" title="What are Group Managed Service Accounts (gMSAs)?">What are Group Managed Service Accounts (gMSAs)?</a></li><li><a href="https://amirsayes.co.uk/2023/02/25/using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through/#" title="Setting up gMSAs for PowerShell Remoting">Setting up gMSAs for PowerShell Remoting</a></li><li><a href="https://amirsayes.co.uk/2023/02/25/using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through/#" title="Troubleshooting gMSAs for PowerShell Remoting">Troubleshooting gMSAs for PowerShell Remoting</a></li><li><a href="https://amirsayes.co.uk/2023/02/25/using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through/#" title="Conclusion">Conclusion</a></li></ul><p>Group Managed Service Accounts (gMSAs) are a feature of Active Directory that allow managed service accounts to be shared across multiple computers. Unlike regular service accounts, which have a fixed password that needs to be changed periodically, gMSAs have an automatically managed password that is synchronized across all the computers that use the account.</p><p>This makes it much easier to manage credentials for remote access, especially when working with large environments that require access to many different servers.</p><h2 id="setting-up-gmsas-for-powershell-remoting" class="heading-0-0-1"><span class="anchor-0-0-2" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Setting up gMSAs for PowerShell Remoting</h2><ol><li>Create the gMSA account in Active Directory:</li></ol><p>To create a gMSA account, you can use the following PowerShell command as a domain admin on a host that has Active Directory Module installed</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="New-ADServiceAccount -Name TestgMSA -DNSHostName testgmsa.yourdomain.com -PrincipalsAllowedToRetrieveManagedPassword &quot;ServerFQDN&quot;" id="code1-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">New-ADServiceAccount</span> <span class="token operator">-</span>Name TestgMSA <span class="token operator">-</span>DNSHostName testgmsa<span class="token punctuation">.</span>yourdomain<span class="token punctuation">.</span>com <span class="token operator">-</span>PrincipalsAllowedToRetrieveManagedPassword <span class="token string">"ServerFQDN"</span></div><br></code></pre><p>In this example, a gMSA account named <code>TestgMSA</code> is created. The <code>DNSHostName</code> parameter specifies the FQDN of the domain that will host the gMSA. The <code>PrincipalsAllowedToRetrieveManagedPassword</code> parameter specifies the groups of computers that are allowed to retrieve the password for the gMSA. In this case we allow the server that we intend to remotely connect to via Powershell “ServerFQDN” to retrive the password</p><ol><li>Install the gMSA on the server(s) you want to connect to using PowerShell remoting:</li></ol><p>To install the gMSA on a server, you need to add it to the local group called <code>Allowed RODC Password Replication Group</code>. You can use the following PowerShell command to do this.</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="Add-ADComputerServiceAccount -Identity SERVER1 -ServiceAccount TestgMSA" id="code2-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">Add-ADComputerServiceAccount</span> <span class="token operator">-</span>Identity SERVER1 <span class="token operator">-</span>ServiceAccount TestgMSA</div><br></code></pre><p>In this example, the <code>TestgMSA</code> gMSA is installed on a server named <code>SERVER1</code>.</p><ol><li>Configure the PowerShell remoting endpoint to use the gMSA:</li></ol><p>Now we move to the target server that we intend to remote into and we create a new PSSession Configuration file.</p><pre class="with-bar"><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="#Run as administrator" id="code3-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">#Run as administrator</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code3-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="New-PSSessionConfigurationFile -Path c:\temp\MySessionConfig.pssc -GroupManagedServiceAccount &quot;labs\TestgMSA&quot; -Full -Verbose" id="code3-l3"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">New-PSSessionConfigurationFile</span> <span class="token operator">-</span>Path c:\temp\MySessionConfig<span class="token punctuation">.</span>pssc <span class="token operator">-</span>GroupManagedServiceAccount <span class="token string">"labs\TestgMSA"</span> <span class="token operator">-</span>Full <span class="token operator">-</span>Verbose</div><br></code></pre><p>When creating a PowerShell Session Configuration (PSSC) file using the <code>New-PSSessionConfigurationFile</code> cmdlet with the <code>-Full</code> parameter, you will be presented with a number of options that you can configure in the generated file to define the behavior of the PSSC file. Initially many of them will be commented out. Here are the some of the options that you will see:</p><p><strong>ModulesToImport</strong>: This option allows you to specify one or more PowerShell modules that will be automatically imported when the PSSC is used. For example, you might specify the <code>ActiveDirectory</code> module if your PSSC is designed to manage Active Directory.</p><p><strong>VisibleCmdlets</strong>: This option allows you to specify the cmdlets that will be available to users of the PSSC. You can specify individual cmdlets, or you can use wildcards to specify multiple cmdlets at once. For example, you might allow users to run all <code>Get-*</code> cmdlets, but restrict their ability to run <code>Set-*</code> cmdlets.</p><p><strong>VisibleFunctions</strong>: This option allows you to specify the functions that will be available to users of the PSSC. As with <code>VisibleCmdlets</code>, you can specify individual functions or use wildcards to specify multiple functions. For example, you might allow users to run all functions that start with <code>New-</code>, but restrict their ability to run functions that start with <code>Remove-</code>.</p><p><strong>VisibleAliases</strong>: This option allows you to specify the aliases that will be available to users of the PSSC. Once again, you can specify individual aliases or use wildcards to specify multiple aliases. For example, you might allow users to use the <code>ls</code> alias to run <code>Get-ChildItem</code>, but restrict their ability to use the <code>rm</code> alias to run <code>Remove-Item</code>.</p><p><strong>StartupScript</strong>: This option allows you to specify a script that will be run when the PSSC is started. This can be useful for setting up variables or functions that will be needed by users of the PSSC. For example, you might define a function that all users of the PSSC will need to use, and have it automatically loaded when the PSSC starts.</p><p><strong>RunAsVirtualAccount</strong>: This option allows you to specify whether the PSSC should run as a virtual account. Virtual accounts are designed to provide a secure way to run services, and can be useful in situations where you need to isolate the PSSC from other parts of the system. <strong>Don’t enable this when using gMSA. More on that in the troubleshooting section below.</strong></p><p><strong>SessionType</strong>: This option allows you to specify the type of session that the PSSC will create. There are three types of sessions: <code>RestrictedRemoteServer</code>, <code>DefaultRemoteShell</code>, and <code>Empty</code>. <code>RestrictedRemoteServer</code> is the most restrictive, allowing only a limited set of cmdlets and functions to be run. <code>DefaultRemoteShell</code> is less restrictive, and allows more cmdlets and functions to be run. <code>Empty</code> is the least restrictive, and allows all cmdlets and functions to be run.</p><p><strong>TranscriptDirectory</strong>: This option allows you to specify the directory where transcripts of sessions created with the PSSC should be stored. Transcripts can be useful for auditing purposes, as they provide a record of all commands run during a session.</p><p><strong>RoleDefinitions</strong>: This option allows you to specify one or more roles that users can be assigned to when connecting to the PSSC. Each role can have its own set of cmdlets, functions, and aliases that are available to users assigned to that role. For example, you might create a <code>Helpdesk</code> role that only allows users to run a limited set of cmdlets and functions related to user account management.</p><p><strong>PrivateData</strong>: This option allows you to specify any additional data that should be associated</p><p>This will create a new pssc file under c:\temp that includes all possible configurations. Some of which are created with default values and you need to review each one explained above to suit your needs. For more information about each options and how to secure your configuration, <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_session_configuration_files?view=powershell-5.1">see about_Session_Configuration_Files</a></p><p>Next, you need to register the session configuration on the target server ensuring that the -RunAsCredential parameter is using the gMSA</p><p><img src="https://i0.wp.com/amirsayes.co.uk/wp-content/uploads/2023/02/gMSA_PSSC_file.png?resize=750%2C488&amp;ssl=1" alt=""></p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="Register-PSSessionConfiguration -Path &quot;c:\temp\MySessionConfig.pssc&quot; -Name MySessionConfig -RunAsCredential TestDomain\TestgMSA$ -ShowSecurityDescriptorUI" id="code4-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">Register-PSSessionConfiguration</span> <span class="token operator">-</span>Path <span class="token string">"c:\temp\MySessionConfig.pssc"</span> <span class="token operator">-</span>Name MySessionConfig <span class="token operator">-</span>RunAsCredential TestDomain\TestgMSA$ <span class="token operator">-</span>ShowSecurityDescriptorUI</div><br></code></pre><p>When you execute the above, you might get prompted to enter a password for the gMSA! Don’t panic!</p><p><img src="https://i0.wp.com/amirsayes.co.uk/wp-content/uploads/2023/02/image.png?resize=332%2C269&amp;ssl=1" alt=""></p><p>If you click OK on this, you may get the following warning along with pop up permissions window that allows you to specify what permissions</p><pre class="with-bar"><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="WARNING: When RunAs is enabled in a Windows PowerShell session configuration, the Windows security model cannot enforce a security boundary between different user sessions that are created by using this endpoint. Verify that the W" id="code5-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>WARNING: When RunAs is enabled in a Windows PowerShell session configuration<span class="token punctuation">,</span> the Windows security model cannot enforce a security boundary between different user sessions that are created by <span class="token keyword">using</span> this endpoint<span class="token punctuation">.</span> Verify that the W</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="indows PowerShell runspace configuration is restricted to only the necessary set of cmdlets and capabilities." id="code5-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>indows PowerShell runspace configuration is restricted to only the necessary <span class="token function">set</span> of cmdlets and capabilities<span class="token punctuation">.</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="WARNING: Register-PSSessionConfiguration may need to restart the WinRM service if a configuration using this name has recently been unregistered, certain system data structures may still be cached. In that case, a restart of WinRM" id="code5-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>WARNING: <span class="token function">Register-PSSessionConfiguration</span> may need to restart the WinRM service <span class="token keyword">if</span> a configuration <span class="token keyword">using</span> this name has recently been unregistered<span class="token punctuation">,</span> certain system <span class="token keyword">data</span> structures may still be cached<span class="token punctuation">.</span> In that case<span class="token punctuation">,</span> a restart of WinRM</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="may be required." id="code5-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>may be required<span class="token punctuation">.</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session configurations that are created with the Register-PSSessionConfiguration cmdlet, are disconnected." id="code5-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>All WinRM sessions connected to Windows PowerShell session configurations<span class="token punctuation">,</span> such as Microsoft<span class="token punctuation">.</span>PowerShell and session configurations that are created with the <span class="token function">Register-PSSessionConfiguration</span> cmdlet<span class="token punctuation">,</span> are disconnected<span class="token punctuation">.</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="  WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin" id="code5-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  WSManConfig: Microsoft<span class="token punctuation">.</span>WSMan<span class="token punctuation">.</span>Management\WSMan::localhost\Plugin</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="Type            Keys                                Name" id="code5-l13"><span class="lineCounter-0-0-13 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">Type</span>            Keys                                Name</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l14"><span class="lineCounter-0-0-13 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="----            ----                                ----" id="code5-l15"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token operator">--</span><span class="token operator">--</span>            <span class="token operator">--</span><span class="token operator">--</span>                                <span class="token operator">--</span><span class="token operator">--</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code5-l16"><span class="lineCounter-0-0-13 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="Container       {Name=MySessionConfig}              MySessionConfig" id="code5-l17"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>Container       <span class="token punctuation">{</span>Name=MySessionConfig<span class="token punctuation">}</span>              MySessionConfig</div><br></code></pre><p>In this Permissions popup, you set what level of permissions the user (e.g. administrator), initiating the PSSession using the pssc file would have when the session is established. For example, to run Invoke-Command cmdlet using the configuration file pssc created above, you would need at least Execute(Invoke) permissions. For simplicity, I am granting Full Control below.</p><p><img src="https://i0.wp.com/amirsayes.co.uk/wp-content/uploads/2023/02/image-1.png?resize=369%2C456&amp;ssl=1" alt=""></p><p>To configure the PowerShell remoting endpoint to use the gMSA, you can use the <code>Set-PSSessionConfiguration</code> cmdlet. Here is an example:</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="Set-PSSessionConfiguration -Name Microsoft.PowerShell -RunAsCredential (Get-Credential &quot;DOMAIN\TestgMSA&quot;) -Force" id="code6-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">Set-PSSessionConfiguration</span> <span class="token operator">-</span>Name Microsoft<span class="token punctuation">.</span>PowerShell <span class="token operator">-</span>RunAsCredential <span class="token punctuation">(</span><span class="token function">Get-Credential</span> <span class="token string">"DOMAIN\TestgMSA"</span><span class="token punctuation">)</span> <span class="token operator">-</span>Force</div><br></code></pre><p>In this example, the <code>Microsoft.PowerShell</code> session configuration is updated to use the gMSA named <code>TestgMSA</code>. The <code>-</code>RunAsCredential parameter specifies the gMSA credentials. The <code>-Force</code> parameter forces the update even if the session configuration is in use.</p><ol><li>Test the gMSA configuration:</li></ol><p>By default, the WinRM client (i.e., the computer initiating the PowerShell remoting session) will only allow connections to trusted remote hosts. This is a security feature designed to prevent unauthorized connections to remote hosts.</p><p>When using PowerShell remoting with a gMSA, the client must trust the remote server’s hostname or IP address in order to connect to it using WinRM. This is why you need to run the <code>Set-Item WSMan:\localhost\Client\TrustedHosts</code> command on the client side to add the server’s hostname to the trusted hosts list.</p><p>By adding the remote server’s hostname to the trusted hosts list, you are explicitly telling the WinRM client to trust connections to that server. This ensures that the client can securely connect to the remote server using PowerShell remoting with a gMSA.</p><pre class=""><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="Set-Item WSMan:\localhost\Client\TrustedHosts -Value Server_Name -Force" id="code7-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">Set-Item</span> WSMan:\localhost\Client\TrustedHosts <span class="token operator">-</span>Value Server_Name <span class="token operator">-</span>Force</div><br></code></pre><p>To test the gMSA configuration, you can use the following PowerShell command:</p><pre class="with-bar"><code class="powershell -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-17"><span></span><span></span><span></span><span></span></span><div class="line-0-0-16  -codedoc-code-line" data-content="#Start a session from the client to the server using the gMSA" id="code8-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">#Start a session from the client to the server using the gMSA</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code8-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="$session = New-PSSession -ComputerName Server_Name -ConfigurationName MySessionConfig" id="code8-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token variable">$session</span> = <span class="token function">New-PSSession</span> <span class="token operator">-</span>ComputerName Server_Name <span class="token operator">-</span>ConfigurationName MySessionConfig</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code8-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="#test who is the user running the remote connection" id="code8-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment">#test who is the user running the remote connection</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code8-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="Invoke-Command -Session $session {" id="code8-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token function">Invoke-Command</span> <span class="token operator">-</span>Session <span class="token variable">$session</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code8-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="     [System.Security.Principal.WindowsIdentity]::GetCurrent().Name" id="code8-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>     <span class="token namespace">[System.Security.Principal.WindowsIdentity]</span>::GetCurrent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</div><br><div class="line-0-0-16  -codedoc-code-line" data-content="" id="code8-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-16  -codedoc-code-line" data-content="}" id="code8-l11"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>If the test was successful, the above code should return the gMSA name. This proves that your Posh remote session context is actually using the gMSA.</p><h2 id="troubleshooting-gmsas-for-powershell-remoting" class="heading-0-0-1"><span class="anchor-0-0-2" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Troubleshooting gMSAs for PowerShell Remoting</h2><p>Even after following the steps above, you may encounter issues when setting up and using gMSAs for PowerShell remoting. Here are some common issues and their solutions:</p><ol><li><strong>Prompted for a password when connecting to a remote server.</strong> Even after passing in the gMSA as the credential parameter to the New-PSSession cmdlet, you may still be prompted for a password. One possible solution is to append a “$” character to the end of the gMSA name to indicate that no password is required.</li><li><strong>Using a virtual account instead of the gMSA.</strong> If the PSSessionConfiguration file has the RunAsVirtualAccount parameter set to $true, the session will run under a virtual account created by WinRM instead of the gMSA account. Setting this parameter to $false should allow the session to use the gMSA account.</li><li><strong>Limiting the use of gMSAs to a specific user or use case.</strong> To limit the use of gMSAs to a specific user or use case, you can configure permissions on the gMSA account itself or on the servers that the gMSA will access. You can also configure auditing to track when the gMSA is used and by whom.</li></ol><p>By following these troubleshooting steps and best practices, you should be able to set up and use gMSAs for PowerShell remoting in a secure and efficient manner.</p><h2 id="conclusion" class="heading-0-0-1"><span class="anchor-0-0-2" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Conclusion</h2><p>Group Managed Service Accounts (gMSAs) are a feature of Active Directory that allow managed service accounts to be shared across multiple computers. Unlike regular service accounts, which have a fixed password that needs to be changed periodically, gMSAs have an automatically managed password that is synchronized across all the computers that use the account.</p><div class="contentnav-0-0-11" data-no-search=""><a href="#using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through---amir-sayes" class="h1" data-content-highlight="using-group-managed-service-accounts-gmsas-for-powershell-remoting-a-walk-through---amir-sayes">Using Group Managed Service Accounts (gMSAs) for PowerShell Remoting: A Walk-through - Amir Sayes</a><a href="#setting-up-gmsas-for-powershell-remoting" class="h2" data-content-highlight="setting-up-gmsas-for-powershell-remoting">Setting up gMSAs for PowerShell Remoting</a><a href="#troubleshooting-gmsas-for-powershell-remoting" class="h2" data-content-highlight="troubleshooting-gmsas-for-powershell-remoting">Troubleshooting gMSAs for PowerShell Remoting</a><a href="#conclusion" class="h2" data-content-highlight="conclusion">Conclusion</a></div></div><div id="-codedoc-toc" class="toc-0-0-8"><div class="content-0-0-9"><div class="heading-0-0-3">Index</div><p><a href="/codedoc/">Home</a>
<a href="/codedoc/README">Index</a>
<a href="/codedoc/docs/Kostwein">Kostwein</a></p><div class="collapse-0-0-4 "><script id="ljMMNzvKFm">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ljMMNzvKFm", "yAdNJkOJGbj52dvfV+HpdQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">PSModulesHelp</span><span class="icon-font closed">chevron_right</span></div><div class="content"><p><a href="/codedoc/docs/PSModulesHelp/ModuleDoku">PS Modules Help</a></p><hr></div></div><div class="collapse-0-0-4 "><script id="MfydUJofNi">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("MfydUJofNi", "yAdNJkOJGbj52dvfV+HpdQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">KnowledgeBase</span><span class="icon-font closed">chevron_right</span></div><div class="content"><blockquote><p><a href="/codedoc/docs/Knowledge/PowerShell/Index">PowerShell</a></p></blockquote></div></div><div class="collapse-0-0-4 "><script id="ThchWBFFQf">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ThchWBFFQf", "yAdNJkOJGbj52dvfV+HpdQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">Links</span><span class="icon-font closed">chevron_right</span></div><div class="content"><blockquote><p><a href="/codedoc/docs/Links/LinksWiki">Index</a></p></blockquote></div></div><div class="collapse-0-0-4 "><script id="inIkWLNMDM">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("inIkWLNMDM", "yAdNJkOJGbj52dvfV+HpdQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script><div class="label" onclick="this.parentElement.classList.toggle('open')"><span class="text">Veeam</span><span class="icon-font closed">chevron_right</span></div><div class="content"><blockquote><p><a href="/codedoc/docs/Knowledge/Veeam/Best%20Practices/index">Best Practices</a></p></blockquote></div></div><p><a href="/codedoc/docs/cheat-sheet">Markdown Cheat Sheet</a>
<a href="/codedoc/docs/code-features">Code Features</a></p><p><br><br></p><p>To add links to your other documents, simply
modify contents of <code>docs/md/_toc.md</code>.</p></div><div class="search-0-0-10"><script id="ioyKnwmFuv">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ioyKnwmFuv", "EKtVWhWp+AfK3O64A4+bOg==", {"repo":"codedoc","user":"In-Pro-Org","root":"docs/md","pick":"\\.md$","drop":"(^_)|(\\/_)"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script></div></div><div class="footer-0-0-7"><div class="left"><script id="sFbnIgBhQH">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("sFbnIgBhQH", "wCsMx1XMyC4jNi3FxvjU4g==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script></div><div class="main"><div class="inside"><a href="https://github.com/In-Pro-Org/codedoc/" target="_blank">GitHub</a></div></div><div class="right"><script id="adihGSAfwE">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("adihGSAfwE", "6W59GcSTLBVXRr/Nl/rTkw==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script></div></div><script id="QKCo_jyHqO">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("QKCo_jyHqO", "zKXJ5zf13oJGCwAAI3JIIA==", {"namespace":"/codedoc"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); window.setImmediate = window.setImmediate || function(f){setTimeout(f, 0)}; })()</script></body></html>